<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meta-Transaction Example</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
        type="application/javascript"></script>
</head>
<body>
    <h1>Meta-Transaction Example</h1>
    <form id="metaTxForm">
        <label for="spender">Spender Address:</label>
        <input type="text" id="spender" name="spender" required><br><br>
        <label for="value">Approve Value:</label>
        <input type="number" id="value" name="value" required><br><br>
        <button type="submit">Send Meta-Transaction</button>
    </form>

    <script>
        const relayContractAddress = "0x44d635c836b380A3cAd70678512d23d357E9e884";
        const relayContractABI = [
            "function metaApprove(address token, address owner, address spender, uint256 value, uint256 deadline, uint8 v, bytes32 r, bytes32 s) external",
            "function nonces(address) view returns (uint256)"
        ];

        async function main() {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const signer = provider.getSigner();
            const userAddress = await signer.getAddress();

            const form = document.getElementById("metaTxForm");
            form.addEventListener("submit", async (event) => {
                event.preventDefault();

                const spender = document.getElementById("spender").value;
                const value = document.getElementById("value").value;
                const currentTime = Math.floor(Date.now() / 1000);
                const expirationDuration = 3600; // 1 hour in seconds
                const deadline = currentTime + expirationDuration;

                const nonce = await getNonce(userAddress);

                const domain = {
                    name: "MetaTransactionRelay",
                    version: "1",
                    chainId: 81457,
                    verifyingContract: relayContractAddress
                };

                const types = {
                    MetaApprove: [
                        { name: "owner", type: "address" },
                        { name: "spender", type: "address" },
                        { name: "value", type: "uint256" },
                        { name: "nonce", type: "uint256" },
                        { name: "deadline", type: "uint256" }
                    ]
                };

                const message = {
                    owner: userAddress,
                    spender: spender,
                    value: value,
                    nonce: nonce,
                    deadline: deadline
                };

                const signature = await signer._signTypedData(domain, types, message);

                const { r, s, v } = ethers.utils.splitSignature(signature);

                const relayData = {
                    from: userAddress,
                    to: relayContractAddress,
                    data: new ethers.utils.Interface(relayContractABI).encodeFunctionData("metaApprove", [
                        "0xb9dfCd4CF589bB8090569cb52FaC1b88Dbe4981F", // Token address
                        userAddress,
                        spender,
                        value,
                        deadline,
                        v,
                        r,
                        s
                    ])
                };

                fetch("https://meta-tx-server.dglive.org/v1/transactions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(relayData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Meta-Transaction sent:", data);
                })
                .catch(error => {
                    console.error("Error sending meta-transaction:", error);
                });
            });
        }

        async function getNonce(userAddress) {
            const POLProvider = new ethers.providers.JsonRpcProvider("https://polygon-mainnet.g.alchemy.com/v2/ncx52BUu0ARYIishpcAGXjQQqnvzdy-c");
            const relayContract = new ethers.Contract(relayContractAddress, relayContractABI, POLProvider);
            return await relayContract.nonces(userAddress);
        }

        window.addEventListener('load', main);
    </script>
</body>
</html>
